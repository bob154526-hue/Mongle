<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lurking Gaze</title>
  <style>
    body { 
      margin:0; overflow:hidden; background:#000; font-family: 'Courier New', Courier, monospace; 
      transition: filter 0.4s ease, background 0.8s;
    }
    body.lowSanity { 
      filter: saturate(0.55) contrast(1.35) brightness(0.85); 
      background: #0a0000;
    }
    #ui {
      position: absolute;
      top: 18px; left: 50%; transform: translateX(-50%);
      color: #d00; font-size: 1.5rem; letter-spacing: 2px;
      text-shadow: 0 0 10px #000, 0 0 20px #400;
      pointer-events: none; user-select: none; z-index: 100;
      opacity: 0.92;
    }
    #sanityBar {
      width: 360px; height: 28px; background: #111;
      border: 3px solid #400; border-radius: 6px; overflow: hidden;
      box-shadow: inset 0 0 15px #000, 0 0 25px rgba(200,0,0,0.3);
    }
    #sanityFill {
      height: 100%; background: linear-gradient(90deg, #c00 0%, #ff4400 45%, #ffaa00 100%);
      transition: width 0.18s ease-out;
      box-shadow: inset 0 0 12px #fff;
    }
    body.lowSanity #sanityFill { animation: panic 0.7s infinite alternate; }
    @keyframes panic {
      0% { box-shadow: 0 0 12px #f00; transform: scaleX(1); }
      100% { box-shadow: 0 0 40px #f00, inset 0 0 20px #f00; transform: scaleX(1.04); }
    }
    #crosshair {
      position: absolute; inset: 0; margin: auto;
      width: 22px; height: 22px; pointer-events: none;
      background: radial-gradient(circle, transparent 30%, #f008 38%, #f008 62%, transparent 70%),
                  conic-gradient(transparent 0deg 80deg, #800 80deg 100deg, #f008 100deg 260deg, transparent 260deg 360deg);
      border-radius: 50%; opacity: 0.88; transition: all 0.25s;
    }
    body.lowSanity #crosshair {
      animation: distort 1.2s infinite;
      width: 28px; height: 28px; opacity: 1;
    }
    @keyframes distort {
      0%,100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.4) rotate(45deg); }
    }
    #titleScreen, #deathScreen {
      position: absolute; inset: 0;
      background: rgba(8,0,0,0.97); color: #c00;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-size: 2.8rem; text-align: center; text-shadow: 0 0 15px #000;
      pointer-events: all; z-index: 300;
      backdrop-filter: blur(5px);
    }
    #titleScreen h1 {
      font-size: 5.2rem; margin: 0 0 50px; letter-spacing: 8px; color: #f22;
      text-shadow: 0 0 30px #800, 0 0 60px #400;
      animation: flicker 4s infinite;
    }
    @keyframes flicker {
      0%,19%,21%,23%,25%,54%,56%,100% { opacity:1; text-shadow:0 0 30px #800; }
      20%,22%,24%,55% { opacity:0.4; text-shadow:none; }
    }
    #titleScreen p { font-size: 1.5rem; margin: 12px; opacity: 0.85; line-height: 1.4; }
    #deathScreen { display: none; }
    #deathScreen h1 { font-size: 6rem; color: #f00; animation: shakeDeath 0.6s infinite; }
    @keyframes shakeDeath {
      0%,100% { transform: translateX(0) scale(1); }
      10%,30%,50%,70%,90% { transform: translateX(-12px) scale(1.03); }
      20%,40%,60%,80% { transform: translateX(12px) scale(1.03); }
    }
    button {
      margin-top: 40px; padding: 20px 60px;
      background: #400; color: #fff; border: 3px solid #800;
      font-size: 1.8rem; border-radius: 8px; cursor: pointer;
      transition: all 0.25s; box-shadow: 0 0 30px rgba(255,0,0,0.4);
    }
    button:hover {
      background: #600; transform: scale(1.08); box-shadow: 0 0 50px #f00;
    }
  </style>
</head>
<body>

<div id="titleScreen">
  <h1>LURKING GAZE</h1>
  <p>Click anywhere to descend</p>
  <p>WASD / Arrows → Move<br>Mouse → Look</p>
  <p><strong>Never look directly at them.</strong><br>The longer you stare — the faster your mind fractures.</p>
</div>

<div id="deathScreen">
  <h1>GAZE RETURNED</h1>
  <p>They saw you. You are no longer alone.</p>
  <button onclick="location.reload()">TRY AGAIN IN THE DARK</button>
</div>

<div id="ui">
  <div id="sanityBar"><div id="sanityFill" style="width:100%"></div></div>
</div>
<div id="crosshair"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/PointerLockControls.js"></script>

<script>
// ──────────────────────────────────────────────────────────────────────
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x080808);
scene.fog = new THREE.FogExp2(0x030303, 0.024);

const camera = new THREE.PerspectiveCamera(76, innerWidth/innerHeight, 0.08, 90);
camera.position.set(0, 1.62, 4);

const renderer = new THREE.WebGLRenderer({antialias:true, powerPreference:"high-performance"});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

// Controls + lock
const controls = new THREE.PointerLockControls(camera, renderer.domElement);
scene.add(controls.getObject());

const titleScreen = document.getElementById('titleScreen');
const deathScreen  = document.getElementById('deathScreen');
const sanityFill   = document.getElementById('sanityFill');

titleScreen.addEventListener('click', () => controls.lock());
controls.addEventListener('lock',   () => titleScreen.style.display = 'none');
controls.addEventListener('unlock', () => { if (!gameOver) titleScreen.style.display = 'flex'; });

let keys = { w:false, s:false, a:false, d:false };
window.addEventListener('keydown', e => { if ('wsad'.includes(e.key.toLowerCase())) keys[e.key.toLowerCase()] = true; });
window.addEventListener('keyup',   e => { if ('wsad'.includes(e.key.toLowerCase())) keys[e.key.toLowerCase()] = false; });

const SPEED = 7.4;

// ─── Audio Context & Noises ──────────────────────────────────────────
let audioCtx = null, heartbeatTimer = 0, stepTimer = 0;
let breathing = null, breathGain = null, breathFilter = null;

function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function whiteNoise(duration = 4) {
  const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * duration, audioCtx.sampleRate);
  const data = buf.getChannelData(0);
  for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
  return buf;
}

const noiseBuf = whiteNoise(5);

function startBreathing() {
  if (breathing) breathing.stop();
  breathing = audioCtx.createBufferSource();
  breathing.buffer = noiseBuf; breathing.loop = true;
  breathFilter = audioCtx.createBiquadFilter(); breathFilter.type = 'lowpass'; breathFilter.frequency.value = 420;
  breathGain = audioCtx.createGain(); breathGain.gain.value = 0;
  breathing.connect(breathFilter).connect(breathGain).connect(audioCtx.destination);
  breathing.start();
}

function heartbeat() {
  const osc = audioCtx.createOscillator(); osc.type = 'sine'; osc.frequency.value = 60;
  const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.35);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.35);
}

function loudJumpscare() {
  const osc = audioCtx.createOscillator(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 0.9);
  const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0.7, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.4);
  osc.connect(gain).connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 1.4);
}

// ─── World ───────────────────────────────────────────────────────────
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(160, 160),
  new THREE.MeshStandardMaterial({color:0x0b0b0b, roughness:0.97})
);
floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

function wall(x,z,w,d,h=6.2) {
  const m = new THREE.Mesh(
    new THREE.BoxGeometry(w,h,d),
    new THREE.MeshStandardMaterial({color:0x151515, roughness:0.9})
  );
  m.position.set(x, h/2, z); m.castShadow = m.receiveShadow = true;
  scene.add(m);
}

// Outer box
wall(0,-45,100,4); wall(0,45,100,4);
wall(-50,0,4,94); wall(50,0,4,94);

// Maze-ish corridors + clutter
for (let i = -4; i <= 4; i++) {
  if (Math.abs(i)%2===1) {
    wall(i*9, 0, 3, 35 + Math.random()*20);
    wall(0, i*9, 35 + Math.random()*20, 3);
  }
}
for (let i = 0; i < 16; i++) {
  const ang = i * 1.57 + Math.random()*0.8;
  const r = 12 + Math.random()*28;
  wall(Math.cos(ang)*r, Math.sin(ang)*r, 2.8+Math.random()*3, 2.8+Math.random()*3);
}

// ─── Lights ──────────────────────────────────────────────────────────
scene.add(new THREE.AmbientLight(0x1a1a44, 0.35));

const playerLantern = new THREE.PointLight(0xffaa77, 2.4, 28, 2.1);
playerLantern.castShadow = true; playerLantern.shadow.mapSize.set(1024,1024);
scene.add(playerLantern);

const flickerPhase = Math.random()*20;

// ─── Entities (The Lurkers) ──────────────────────────────────────────
const lurkerGeo = new THREE.CylinderGeometry(0.22, 0.8, 4.8, 6, 1, true);
const lurkerMat = new THREE.MeshStandardMaterial({
  color: 0x0a110a, emissive: 0x0f1f0f, emissiveIntensity: 0.9, roughness: 0.2
});
const lurkers = [];
for (let i = 0; i < 6; i++) {
  const l = new THREE.Mesh(lurkerGeo, lurkerMat.clone());
  l.position.set(
    (Math.random()-0.5)*80,
    2.4,
    (Math.random()-0.5)*80 - 20
  );
  l.castShadow = true; l.visible = false;
  l.userData = { phase: Math.random()*100, speed: 1.4 + Math.random()*0.9 };
  scene.add(l); lurkers.push(l);
}

// ─── Game State ──────────────────────────────────────────────────────
let sanity = 100;
let gameOver = false;
let prevTime = performance.now();

function animate(now) {
  requestAnimationFrame(animate);
  const dt = Math.min(0.06, (now-prevTime)/1000);
  prevTime = now;

  if (!controls.isLocked || gameOver) {
    renderer.render(scene, camera);
    return;
  }

  initAudio(); if (audioCtx?.state==='suspended') audioCtx.resume();

  // ── Movement ───────────────────────────────────────────────────────
  const move = new THREE.Vector3();
  const fwd = new THREE.Vector3(); camera.getWorldDirection(fwd); fwd.y=0; fwd.normalize();
  const rgt = new THREE.Vector3().crossVectors(fwd, new THREE.Vector3(0,1,0)).normalize();

  const spd = SPEED * dt;
  if (keys.w) move.addScaledVector(fwd,  spd);
  if (keys.s) move.addScaledVector(fwd, -spd*0.65);
  if (keys.a) move.addScaledVector(rgt, -spd*0.8);
  if (keys.d) move.addScaledVector(rgt,  spd*0.8);

  controls.moveForward(move.z);
  controls.moveRight(move.x);

  const isMoving = move.length() > 0.005;

  // Lantern follows eyes + slight bob
  playerLantern.position.copy(camera.position);
  playerLantern.position.y -= 0.5 + Math.sin(now*0.003)*0.08;

  // Flicker + dim with sanity
  const t = now*0.001;
  playerLantern.intensity = (2.4 + Math.sin(t*18)*0.9 + Math.sin(t*41)*0.5)
                          * (0.4 + 0.6 * (sanity/100));

  // ── Lurkers logic ──────────────────────────────────────────────────
  let closest = 999;
  let visibleCount = 0;
  const lookDir = new THREE.Vector3(); camera.getWorldDirection(lookDir);

  lurkers.forEach(l => {
    const dist = camera.position.distanceTo(l.position);
    if (dist < closest) closest = dist;

    if (dist < 32) {
      const chase = new THREE.Vector3().subVectors(camera.position, l.position);
      chase.y = 0; chase.normalize();
      l.position.addScaledVector(chase, l.userData.speed * dt * (1 + (100-sanity)/80));
      l.lookAt(camera.position.x, l.position.y, camera.position.z);

      l.userData.phase += dt*9;
      l.scale.y = 1 + 0.25 * Math.sin(l.userData.phase);
    }

    const toL = new THREE.Vector3().subVectors(l.position, camera.position).normalize();
    const dot = lookDir.dot(toL);
    l.visible = (dot > 0.78 && dist < 32);
    if (l.visible) visibleCount++;
  });

  // ── Sanity drain ───────────────────────────────────────────────────
  sanity -= (visibleCount * 65 + Math.max(0, 14 - closest)*3) * dt;
  if (closest > 38 && visibleCount === 0) sanity += 18 * dt;
  sanity = Math.max(0, Math.min(100, sanity));

  sanityFill.style.width = sanity + '%';

  // ── Audio ──────────────────────────────────────────────────────────
  // Breathing
  const breathI = Math.max(0, (20 - closest)/20) * (1 - sanity/100 * 0.4);
  if (breathI > 0.03) {
    if (!breathing) startBreathing();
    breathGain.gain.setTargetAtTime(breathI * 0.18, audioCtx.currentTime, 0.08);
    breathFilter.frequency.setTargetAtTime(300 + breathI*400, audioCtx.currentTime, 0.1);
  } else if (breathing) {
    breathGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1);
    setTimeout(() => { breathing?.stop(); breathing = null; }, 1200);
  }

  // Heartbeat
  if (sanity < 50) {
    const panic = (50 - sanity)/50;
    heartbeatTimer += dt;
    if (heartbeatTimer > 0.9 - panic*0.65) {
      heartbeat(); heartbeatTimer = 0;
    }
  }

  // Steps
  if (isMoving) {
    stepTimer += dt * 4.2;
    if (stepTimer > 0.48) {
      // simple clicky step (you can expand later)
      const osc = audioCtx.createOscillator(); osc.type='triangle'; osc.frequency.value=80+Math.random()*60;
      const g = audioCtx.createGain(); g.gain.setValueAtTime(0.09,0); g.gain.exponentialRampToValueAtTime(0.001,0.22);
      osc.connect(g).connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+0.22);
      stepTimer -= 0.48;
    }
  }

  // ── Visual horror ──────────────────────────────────────────────────
  document.body.classList.toggle('lowSanity', sanity < 42);

  scene.fog.density = 0.024 + (100-sanity)*0.0011;
  camera.fov = 76 + (100-sanity)*0.22; camera.updateProjectionMatrix();

  // Camera shake when very low
  if (sanity < 35) {
    const shake = (35 - sanity)/35 * 0.09;
    camera.position.x += (Math.random()-0.5)*shake;
    camera.position.y += (Math.random()-0.5)*shake*0.6;
    camera.rotation.z += (Math.random()-0.5)*shake*0.4;
  }

  // ── Game over ──────────────────────────────────────────────────────
  if (sanity <= 0 && !gameOver) {
    gameOver = true;
    loudJumpscare();
    deathScreen.style.display = 'flex';
  }

  renderer.render(scene, camera);
}

animate(performance.now());

window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
